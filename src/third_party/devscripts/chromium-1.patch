--- licensecheck.pl.orig	2011-09-22 10:51:25.934402455 -0700
+++ licensecheck.pl	2011-10-03 09:49:41.651443138 -0700
@@ -241,6 +241,12 @@
 my @find_args = ();
 my $files_count = @ARGV;
 
+push @find_args, qw(-not ( -path */LayoutTests/* -prune ) );
+push @find_args, qw(-not ( -path */out/Debug/* -prune ) );
+push @find_args, qw(-not ( -path */out/Release/* -prune ) );
+push @find_args, qw(-not ( -path *.git* -prune ) );
+push @find_args, qw(-not ( -path *.svn* -prune ) );
+
 push @find_args, qw(-maxdepth 1) unless $opt_recursive;
 push @find_args, qw(-follow -type f -print);
 
@@ -277,10 +283,6 @@
     while (<F>) {
         last if ($. > $opt_lines);
         $content .= $_;
-	$copyright_match = parse_copyright($_);
-	if ($copyright_match) {
-	    $copyrights{lc("$copyright_match")} = "$copyright_match";
-	}
     }
     close(F);
 
@@ -298,7 +300,6 @@
 
     $license = parselicense($content);
     print "$file: ";
-    print "*No copyright* " unless $copyright;
     print $license . "\n";
     print "  [Copyright: " . $copyright . "]\n"
       if $copyright and $opt_copyright;
@@ -398,15 +399,11 @@
 	$gplver = " (v$1 or later)";
     }
 
-    if ($licensetext =~ /(?:675 Mass Ave|59 Temple Place|51 Franklin Steet|02139|02111-1307)/i) {
-	$extrainfo = " (with incorrect FSF address)$extrainfo";
-    }
-
     if ($licensetext =~ /permission (?:is (also granted|given))? to link (the code of )?this program with (any edition of )?(Qt|the Qt library)/i) {
 	$extrainfo = " (with Qt exception)$extrainfo"
     }
 
-    if ($licensetext =~ /(All changes made in this file will be lost|DO NOT (EDIT|delete this file)|Generated by)/i) {
+    if ($licensetext =~ /(All changes made in this file will be lost|DO NOT (EDIT|delete this file)|Generated (automatically|by|from)|generated.*file)/i) {
 	$license = "GENERATED FILE";
     }
 
@@ -414,20 +411,12 @@
 	$license = "LGPL$gplver$extrainfo $license";
     }
 
-    if ($licensetext =~ /is free software.? you can redistribute it and\/or modify it under the terms of the (GNU Affero General Public License|AGPL)/i) {
-	$license = "AGPL$gplver$extrainfo $license";
-    }
-
     if ($licensetext =~ /is free software.? you (can|may) redistribute it and\/or modify it under the terms of (?:version [^ ]+ (?:\(?only\)? )?of )?the GNU General Public License/i) {
 	$license = "GPL$gplver$extrainfo $license";
-    }
-
-    if ($licensetext =~ /is distributed under the terms of the GNU General Public License,/
+    } elsif ($licensetext =~ /is distributed under the terms of the GNU General Public License,/
 	and length $gplver) {
 	$license = "GPL$gplver$extrainfo $license";
-    }
-
-    if ($licensetext =~ /is distributed.*terms.*GPL/) {
+    } elsif ($licensetext =~ /is distributed.*terms.*GPL/) {
 	$license = "GPL (unversioned/unknown version) $license";
     }
 
@@ -437,7 +426,7 @@
 	$license = "QPL $license";
     }
 
-    if ($licensetext =~ /http:\/\/opensource\.org\/licenses\/mit-license\.php/) {
+    if ($licensetext =~ /opensource\.org\/licenses\/mit-license\.php/) {
 	$license = "MIT/X11 (BSD like) $license";
     } elsif ($licensetext =~ /Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files \(the Software\), to deal in the Software/) {
 	$license = "MIT/X11 (BSD like) $license";
@@ -448,15 +437,21 @@
     }
 
     if ($licensetext =~ /THIS SOFTWARE IS PROVIDED .*AS IS AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY/) {
-	if ($licensetext =~ /All advertising materials mentioning features or use of this software must display the following acknowledge?ment.*This product includes software developed by/i) {
+	if ($licensetext =~ /All advertising materials mentioning features or use of this software must display the following/) {
 	    $license = "BSD (4 clause) $license";
-	} elsif ($licensetext =~ /(The name of .*? may not|Neither the names? of .*? nor the names of (its|their) contributors may) be used to endorse or promote products derived from this software/i) {
+	} elsif ($licensetext =~ /be used to endorse or promote products derived from this software/) {
 	    $license = "BSD (3 clause) $license";
-	} elsif ($licensetext =~ /Redistributions of source code must retain the above copyright notice/i) {
+	} elsif ($licensetext =~ /Redistributions of source code must retain the above copyright notice/) {
 	    $license = "BSD (2 clause) $license";
 	} else {
 	    $license = "BSD $license";
 	}
+    } elsif ($licensetext =~ /Use of this source code is governed by a BSD-style license/) {
+        $license = "BSD-like $license";
+    } elsif ($licensetext =~ /BSD terms apply/) {
+        $license = "BSD-like $license";
+    } elsif ($licensetext =~ /GOVERNED BY A BSD-STYLE SOURCE LICENSE/) {
+        $license = "BSD-like $license";
     }
 
     if ($licensetext =~ /Mozilla Public License Version ([^ ]+)/) {
@@ -475,7 +470,9 @@
 	$license = "Perl $license";
     }
 
-    if ($licensetext =~ /under the Apache License, Version ([^ ]+)/) {
+    if ($licensetext =~ /under the terms of the Apache ([^ ]+) License OR version 2 of the GNU/) {
+	$license = "Apache (v$1) GPL (v2) $license";
+    } elsif ($licensetext =~ /under the Apache License, Version ([^ ]+)/) {
 	$license = "Apache (v$1) $license";
     }
 
@@ -495,7 +492,7 @@
 	$license = "SGI Free Software License B $license";
     }
 
-    if ($licensetext =~ /is in the public domain/i) {
+    if ($licensetext =~ /in the public domain/i) {
 	$license = "Public domain";
     }
 
@@ -503,6 +500,17 @@
 	$license = "CDDL " . ($1 ? "(v$2) " : '') . $license;
     }
 
+    if ($licensetext =~ /Microsoft Permissive License \(Ms-PL\)/) {
+        $license = "Ms-PL $license";
+    }
+
+    if ($licensetext =~ /as defined in and that are subject to the Apple Public Source License([ ,-]+Version ([^ ]+)?(\.))/) {
+	$license = "APSL " . ($1 ? "(v$2) " : '') . $license;
+    } elsif ($licensetext =~ /provided that if you redistribute the Apple Software in its entirety and without modifications, you must retain this notice and the following text and disclaimers in all such redistributions of the Apple Software/) {
+	# https://fedoraproject.org/wiki/Licensing/Apple_MIT_License
+	$license = "Apple MIT $license";
+    }
+
     if ($licensetext =~ /Permission is hereby granted, free of charge, to any person or organization obtaining a copy of the software and accompanying documentation covered by this license \(the \"Software\"\)/ or
 	$licensetext =~ /Boost Software License([ ,-]+Version ([^ ]+)?(\.))/i) {
 	$license = "BSL " . ($1 ? "(v$2) " : '') . $license;
@@ -515,18 +523,8 @@
     if ($licensetext =~ /The origin of this software must not be misrepresented.*Altered source versions must be plainly marked as such.*This notice may not be removed or altered from any source distribution/ or
         $licensetext =~ /see copyright notice in zlib\.h/) {
 	$license = "zlib/libpng $license";
-    }
-
-    if ($licensetext =~ /Do What The Fuck You Want To Public License, Version ([^, ]+)/i) {
-        $license = "WTFPL (v$1)";
-    }
-
-    if ($licensetext =~ /Do what The Fuck You Want To Public License/i) {
-        $license = "WTFPL";
-    }
-
-    if ($licensetext =~ /(License WTFPL|Under (the|a) WTFPL)/i) {
-        $license = "WTFPL";
+    } elsif ($licensetext =~ /This code is released under the libpng license/) {
+        $license = "libpng $license";
     }
 
     $license = "UNKNOWN" if (!length($license));
